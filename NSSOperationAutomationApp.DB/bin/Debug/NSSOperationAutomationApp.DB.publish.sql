/*
Deployment script for NSSOperationAutomationP1

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "NSSOperationAutomationP1"
:setvar DefaultFilePrefix "NSSOperationAutomationP1"
:setvar DefaultDataPath "D:\Microsoft SQL Server\MSSQL16.MSSQLSERVER01\MSSQL\DATA\"
:setvar DefaultLogPath "D:\Microsoft SQL Server\MSSQL16.MSSQLSERVER01\MSSQL\DATA\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Creating User-Defined Table Type [dbo].[udt_T_TicketDetails]...';


GO
CREATE TYPE [dbo].[udt_T_TicketDetails] AS TABLE (
    [CaseNumber]                   VARCHAR (50)    NOT NULL,
    [TicketId]                     BIGINT          NOT NULL,
    [FromEmail]                    VARCHAR (100)   NULL,
    [ToEmail]                      VARCHAR (100)   NULL,
    [CaseSubject]                  NVARCHAR (500)  NULL,
    [WorkOrderNumber]              VARCHAR (50)    NULL,
    [ServiceAccount]               VARCHAR (100)   NULL,
    [ContactName]                  VARCHAR (100)   NULL,
    [ContactEmail]                 VARCHAR (100)   NULL,
    [ContactPhone]                 VARCHAR (100)   NULL,
    [ServiceDeliveryStreetAddress] NVARCHAR (200)  NULL,
    [ServiceDeliveryCity]          NVARCHAR (50)   NULL,
    [ServiceDeliveryCountry]       NVARCHAR (50)   NULL,
    [PostalCode]                   VARCHAR (50)    NULL,
    [SerialNumber]                 NVARCHAR (50)   NULL,
    [ProductName]                  NVARCHAR (100)  NULL,
    [ProductNumber]                VARCHAR (50)    NULL,
    [OTCCode]                      NVARCHAR (100)  NULL,
    [PartNumber]                   NVARCHAR (100)  NULL,
    [PartDescription]              NVARCHAR (1000) NULL,
    [EmailSubject]                 NVARCHAR (500)  NULL,
    [EmailDate]                    VARCHAR (50)    NULL,
    [CreatedOn]                    DATETIME        NULL,
    [PartNumber2]                  NVARCHAR (100)  NULL,
    [PartDescription2]             NVARCHAR (1000) NULL,
    [PartNumber3]                  NVARCHAR (100)  NULL,
    [PartDescription3]             NVARCHAR (1000) NULL,
    [TicketType]                   VARCHAR (10)    NULL,
    [AssignedTo]                   VARCHAR (100)   NULL,
    [AssignedToEmail]              VARCHAR (100)   NULL,
    [AssignedToADID]               VARCHAR (50)    NULL,
    [AssignedBy]                   VARCHAR (100)   NULL,
    [AssignedByEmail]              VARCHAR (100)   NULL,
    [AssignedByADID]               VARCHAR (50)    NULL);


GO
PRINT N'Starting rebuilding table [dbo].[T_TicketDetails]...';


GO
BEGIN TRANSACTION;

SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;

SET XACT_ABORT ON;

CREATE TABLE [dbo].[tmp_ms_xx_T_TicketDetails] (
    [CaseNumber]                   VARCHAR (50)    NOT NULL,
    [TicketId]                     BIGINT          NULL,
    [FromEmail]                    VARCHAR (100)   NULL,
    [ToEmail]                      VARCHAR (100)   NULL,
    [CaseSubject]                  NVARCHAR (500)  NULL,
    [WorkOrderNumber]              VARCHAR (50)    NULL,
    [ServiceAccount]               VARCHAR (100)   NULL,
    [ContactName]                  VARCHAR (100)   NULL,
    [ContactEmail]                 VARCHAR (100)   NULL,
    [ContactPhone]                 VARCHAR (100)   NULL,
    [ServiceDeliveryStreetAddress] NVARCHAR (200)  NULL,
    [ServiceDeliveryCity]          NVARCHAR (50)   NULL,
    [ServiceDeliveryCountry]       NVARCHAR (50)   NULL,
    [PostalCode]                   VARCHAR (50)    NULL,
    [SerialNumber]                 NVARCHAR (50)   NULL,
    [ProductName]                  NVARCHAR (100)  NULL,
    [ProductNumber]                VARCHAR (50)    NULL,
    [OTCCode]                      NVARCHAR (100)  NULL,
    [PartNumber]                   NVARCHAR (100)  NULL,
    [PartDescription]              NVARCHAR (1000) NULL,
    [EmailSubject]                 NVARCHAR (500)  NULL,
    [EmailDate]                    VARCHAR (50)    NULL,
    [CreatedOn]                    DATETIME        NULL,
    [PartNumber2]                  NVARCHAR (100)  NULL,
    [PartDescription2]             NVARCHAR (1000) NULL,
    [PartNumber3]                  NVARCHAR (100)  NULL,
    [PartDescription3]             NVARCHAR (1000) NULL,
    [TicketType]                   VARCHAR (10)    NULL,
    CONSTRAINT [tmp_ms_xx_constraint_PK_T_TicketDetails1] PRIMARY KEY CLUSTERED ([CaseNumber] ASC)
);

IF EXISTS (SELECT TOP 1 1 
           FROM   [dbo].[T_TicketDetails])
    BEGIN
        INSERT INTO [dbo].[tmp_ms_xx_T_TicketDetails] ([CaseNumber], [FromEmail], [ToEmail], [CaseSubject], [WorkOrderNumber], [ServiceAccount], [ContactName], [ContactEmail], [ContactPhone], [ServiceDeliveryStreetAddress], [ServiceDeliveryCity], [ServiceDeliveryCountry], [PostalCode], [SerialNumber], [ProductName], [ProductNumber], [OTCCode], [PartNumber], [PartDescription], [EmailSubject], [EmailDate], [CreatedOn], [PartNumber2], [PartDescription2], [PartNumber3], [PartDescription3])
        SELECT   [CaseNumber],
                 [FromEmail],
                 [ToEmail],
                 [CaseSubject],
                 [WorkOrderNumber],
                 [ServiceAccount],
                 [ContactName],
                 [ContactEmail],
                 [ContactPhone],
                 [ServiceDeliveryStreetAddress],
                 [ServiceDeliveryCity],
                 [ServiceDeliveryCountry],
                 [PostalCode],
                 [SerialNumber],
                 [ProductName],
                 [ProductNumber],
                 [OTCCode],
                 [PartNumber],
                 [PartDescription],
                 [EmailSubject],
                 [EmailDate],
                 [CreatedOn],
                 [PartNumber2],
                 [PartDescription2],
                 [PartNumber3],
                 [PartDescription3]
        FROM     [dbo].[T_TicketDetails]
        ORDER BY [CaseNumber] ASC;
    END

DROP TABLE [dbo].[T_TicketDetails];

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_T_TicketDetails]', N'T_TicketDetails';

EXECUTE sp_rename N'[dbo].[tmp_ms_xx_constraint_PK_T_TicketDetails1]', N'PK_T_TicketDetails', N'OBJECT';

COMMIT TRANSACTION;

SET TRANSACTION ISOLATION LEVEL READ COMMITTED;


GO
PRINT N'Altering Procedure [dbo].[usp_T_Ticket_ByCaseNumber]...';


GO
ALTER PROCEDURE [dbo].[usp_T_Ticket_ByCaseNumber]
(
	@CaseNumber VARCHAR(50) = NULL,
	@TicketId BIGINT = NULL,
	@SerialNumber NVARCHAR(50) = NULL,
	@PartNumber NVARCHAR(100) = NULL,
    @FromDate VARCHAR(10) = NULL,
    @ToDate VARCHAR(10) = NULL,
	@AssignedTo VARCHAR(100) = NULL,
	@AssignedToEmail VARCHAR(50) = NULL,
	@AssignedBy VARCHAR(100) = NULL,
	@AssignedByEmail VARCHAR(50) = NULL,
	@IsAssigned BIT = NULL,
	@CallStatusId INT = NULL,
	@CallActionId INT = NULL
)
AS
BEGIN

	SELECT
        TD.CaseNumber,
		TD.TicketId,
		TD.TicketType,
        FromEmail,
        ToEmail,
        CaseSubject,
        WorkOrderNumber,
        ServiceAccount,
        ContactName,
        ContactEmail,
        ContactPhone,
        ServiceDeliveryStreetAddress,
        ServiceDeliveryCity,
        ServiceDeliveryCountry,
        PostalCode,
        SerialNumber,
        ProductName,
        ProductNumber,
        OTCCode,
        PartNumber,
        PartDescription,
        EmailSubject,
        FORMAT(SWITCHOFFSET(EmailDate, '+05:30'),'yyyy-MM-dd HH:mm:ss') as EmailDate,
        FORMAT(SWITCHOFFSET(CreatedOn, '+05:30'),'yyyy-MM-dd HH:mm:ss') as CreatedOn,
        ISNULL(PartNumber2,'') AS PartNumber2,
        ISNULL(PartDescription2,'')  AS PartDescription2,
        ISNULL(PartNumber3,'') AS PartNumber3,
        ISNULL(PartDescription3,'') AS PartDescription3,
		EA.AssignmentId,
		CASE
			WHEN EA.AssignmentId IS NOT NULL THEN EA.AssignedTo +' (' + EA.AssignedToEmail + ')'
			ELSE 'Not Assigned'
		END AS AssignedTo,
		CASE
			WHEN EA.AssignmentId IS NOT NULL THEN EA.AssignedBy +' (' + EA.AssignedByEmail + ')'
			ELSE 'Not Assigned'
		END AS AssignedBy,
		CASE
			WHEN EA.AssignmentId IS NOT NULL THEN CS.CallStatus
			ELSE '-'
		END AS CallStatus,
		CASE
			WHEN EA.AssignmentId IS NOT NULL AND CA.CallActionId IS NOT NULL THEN CA.CallAction
			ELSE '-'
		END AS CallAction
    FROM [dbo].[T_TicketDetails] TD WITH(NOLOCK)

	LEFT JOIN [dbo].[T_EngineerAssignment] EA ON EA.CaseNumber = TD.CaseNumber

	LEFT JOIN [dbo].[M_CallStatus] CS WITH(NOLOCK) ON CS.CallStatusId = EA.CallStatusId

	LEFT JOIN [dbo].[M_CallAction] CA WITH(NOLOCK) ON CA.CallActionId = EA.CallActionId	

    WHERE
        (ISNULL(@CaseNumber,'')='' OR TD.CaseNumber LIKE @CaseNumber + '%')
		AND (@TicketId IS NULL OR TD.TicketId = @TicketId)
        AND (ISNULL(@SerialNumber,'') = '' OR SerialNumber LIKE @SerialNumber + '%')
        AND (ISNULL(@PartNumber,'')= '' OR PartNumber LIKE @PartNumber + '%')
        AND (ISNULL(@FromDate,'')= '' OR CONVERT(DATE, SWITCHOFFSET(EmailDate, '+05:30')) >= CONVERT(DATE, @FromDate,103))
        AND (ISNULL(@ToDate ,'')= '' OR  CONVERT(DATE, SWITCHOFFSET(EmailDate, '+05:30')) <= CONVERT(DATE, @ToDate,103))
		AND
		(
			(@IsAssigned IS NULL)
			OR
			(@IsAssigned = 0 AND EA.AssignmentId IS NULL)
			OR
			(@IsAssigned = 1 AND EA.AssignmentId IS NOT NULL)
		)
		AND (ISNULL(@AssignedTo,'')='' OR EA.AssignedTo LIKE @AssignedTo + '%')
		AND (ISNULL(@AssignedToEmail,'') = '' OR EA.AssignedToEmail = @AssignedToEmail)
		AND (ISNULL(@AssignedBy,'')='' OR EA.AssignedBy LIKE @AssignedBy + '%')
		AND (ISNULL(@AssignedByEmail,'') = '' OR EA.AssignedByEmail = @AssignedByEmail)
		AND (@CallStatusId IS NULL OR EA.CallStatusId = @CallStatusId)
		AND (@CallActionId IS NULL OR EA.CallActionId = @CallActionId)
	ORDER BY EmailDate DESC;


	IF(ISNULL(@CaseNumber,'') != '')
	BEGIN

		SELECT 
			[AssignmentId]
			,[CaseNumber]
			--,[TicketId]
			,[AssignedTo]
			,[AssignedToEmail]
			,[AssignedToADID]
			--,[AssignedOnUTC]
			,FORMAT(SWITCHOFFSET(AssignedOnUTC, '+05:30'),'yyyy-MM-dd HH:mm:ss') as AssignedOnUTC
			,[AssignedBy]
			,[AssignedByEmail]
			,[AssignedByADID]
			,EA.[CallActionId]
			,CASE 
				WHEN EA.[CallActionId] IS NOT NULL THEN CA.CallAction
				ELSE 'Action Pending'
			 END AS 'CallAction'
			,EA.[CallStatusId]
			,CS.CallStatus
			,[ClosedBy]
			,[ClosedByEmail]
			--,[ClosedOnUTC]
			,FORMAT(SWITCHOFFSET(ClosedOnUTC, '+05:30'),'yyyy-MM-dd HH:mm:ss') as ClosedOnUTC
			,[AdminClosureRemarks]
			,[ClosedByADID]
			--,[CreatedOnUTC]
			,FORMAT(SWITCHOFFSET(CreatedOnUTC, '+05:30'),'yyyy-MM-dd HH:mm:ss') as CreatedOnUTC
		FROM [dbo].[T_EngineerAssignment] EA WITH(NOLOCK)

		INNER JOIN [dbo].[M_CallStatus] CS WITH(NOLOCK) ON CS.CallStatusId = EA.CallStatusId

		LEFT JOIN [dbo].[M_CallAction] CA WITH(NOLOCK) ON CA.CallActionId = EA.CallActionId		

		WHERE EA.CaseNumber = @CaseNumber;

		SELECT
			[AssignmentHistoryId]
			,EAH.[AssignmentId]
			,EAH.[AssignedTo]
			,EAH.[AssignedToEmail]
			,EAH.[AssignedToADID]
			--,[AssignedOnUTC]
			,FORMAT(SWITCHOFFSET(EAH.AssignedOnUTC, '+05:30'),'yyyy-MM-dd HH:mm:ss') as AssignedOnUTC
			,EAH.[AssignedBy]
			,EAH.[AssignedByEmail]
			,EAH.[AssignedByADID]
			,EAH.[CallActionId]
			,CASE 
				WHEN EAH.[CallActionId] IS NOT NULL THEN CA.CallAction
				ELSE 'Action Pending'
			END AS 'CallAction'
			,EAH.[CallStatusId]
			,CS.CallStatus
			,EAH.[ClosedBy]
			,EAH.[ClosedByEmail]
			,EAH.[ClosedByADID]
			--,[ClosedOnUTC]
			,FORMAT(SWITCHOFFSET(EAH.ClosedOnUTC, '+05:30'),'yyyy-MM-dd HH:mm:ss') as ClosedOnUTC
			,EAH.[AdminClosureRemarks]
			--,[CreatedOnUTC]
			,FORMAT(SWITCHOFFSET(EAH.CreatedOnUTC, '+05:30'),'yyyy-MM-dd HH:mm:ss') as CreatedOnUTC
		FROM [dbo].[T_EngineerAssignmentHistory] EAH WITH(NOLOCK)

		INNER JOIN [dbo].[T_EngineerAssignment] EA WITH(NOLOCK)
		ON EAH.AssignmentId = EA.AssignmentId
		AND EA.CaseNumber = @CaseNumber

		INNER JOIN [dbo].[M_CallStatus] CS WITH(NOLOCK) ON CS.CallStatusId = EAH.CallStatusId

		LEFT JOIN [dbo].[M_CallAction] CA WITH(NOLOCK) ON CA.CallActionId = EAH.CallActionId		

		ORDER BY EAH.AssignmentHistoryId DESC;


		SELECT 
			[CallDetailId]
			,[AssignmentId]
			,[UpdatedBy]
			,[UpdatedByEmail]
			,[UpdatedByADID]
			--,[UpdatedOnUTC]
			,FORMAT(SWITCHOFFSET(UpdatedOnUTC, '+05:30'),'yyyy-MM-dd HH:mm:ss') as UpdatedOnUTC
			,CD.[CallActionId]
			,CA.CallAction
			,[CustomerName]
			,[CaseNumber]
			,[UnitSlNo]
			,[PassId]
			,[TaskStartDateTimeIST]
			,[TaskEndDateTimeIST]
			,[CloserRemarks]
			,CD.[PartConsumptionTypeId]
			,PCT.PartConsumptionType
			,[SONo]
			,[RequiredPart]
			,[RequiredSparePartNo]
			,[RequiredPartName]
			,[FaultyPartCTNo]
			,[FailureId]
			,[IssueDescription]
			,[TroubleshootingStep]
			,[FirstPartConsumptionTypeId]
			--,PCT.PartConsumptionType AS 'FirstPartConsumptionType'
			,(SELECT PCT.PartConsumptionType FROM dbo.[M_PartConsumptionType] PCT WITH(NOLOCK) WHERE PCT.PartConsumptionTypeId = FirstPartConsumptionTypeId) AS 'FirstPartConsumptionType'
			,[FirstPartSONo]
			,[FirstRequiredPartName]
			,[ReceivedPartConsumptionTypeId]
			--,PCT.PartConsumptionType AS 'ReceivedPartConsumptionType'
			,(SELECT PCT.PartConsumptionType FROM dbo.[M_PartConsumptionType] PCT WITH(NOLOCK) WHERE PCT.PartConsumptionTypeId = ReceivedPartConsumptionTypeId) AS 'ReceivedPartConsumptionType'
			,[ReceivedPartName]
		FROM [dbo].[T_CallDetails] CD WITH(NOLOCK)

		INNER JOIN [dbo].[M_CallAction] CA WITH(NOLOCK) ON CA.CallActionId = CD.CallActionId

		LEFT JOIN [dbo].[M_PartConsumptionType] PCT WITH(NOLOCK) ON (PCT.PartConsumptionTypeId = CD.PartConsumptionTypeId)

		WHERE CD.CaseNumber = @CaseNumber
		ORDER BY CallDetailId DESC;


		SELECT 
			[DocumentId]
			,CDOC.[CallDetailId]
			,CDOC.[DocumentTypeId]
			,DT.DocumentType
			,[DocumentName]
			,[MimeType]
			,[DocumentUrlPath]
			,[IsActive]
			,[InternalName]
			--,[CreatedOnUCT]
			,FORMAT(SWITCHOFFSET(CreatedOnUCT, '+05:30'),'yyyy-MM-dd HH:mm:ss') as CreatedOnUCT
			--,CDOC.[UpdatedOnUTC]
			,FORMAT(SWITCHOFFSET(CDOC.[UpdatedOnUTC], '+05:30'),'yyyy-MM-dd HH:mm:ss') as UpdatedOnUTC
		FROM [dbo].[T_CallDocuments] CDOC WITH(NOLOCK)

		INNER JOIN [dbo].[M_DocumentType] DT WITH(NOLOCK) ON DT.DocumentTypeId = CDOC.DocumentId

		INNER JOIN [dbo].[T_CallDetails] CD WITH(NOLOCK) 
		ON CD.CallDetailId = CDOC.CallDetailId 
		AND CD.CaseNumber = @CaseNumber
		ORDER BY DocumentId DESC;


	END

END
GO
PRINT N'Altering Procedure [dbo].[usp_T_EngineerAssignment_Get]...';


GO
ALTER PROCEDURE [dbo].[usp_T_EngineerAssignment_Get]
  (
	@AssignmentId BIGINT = NULL,
	@CaseNumber VARCHAR(50) = NULL,
	@TicketId BIGINT = NULL,
	@SerialNumber NVARCHAR(50) = NULL,
	@PartNumber NVARCHAR(100) = NULL,
	@FromDate VARCHAR(10) = NULL,
	@ToDate VARCHAR(10) = NULL,
	@AssignedTo VARCHAR(100) = NULL,
	@AssignedToEmail VARCHAR(50) = NULL,
	@AssignedBy VARCHAR(100) = NULL,
	@AssignedByEmail VARCHAR(50) = NULL,
	@CallStatusId INT = NULL,
	@CallActionId INT = NULL
  )
  AS
  BEGIN

		SELECT 
			[AssignmentId]
			,[CaseNumber]
			,[TicketId]
			,[AssignedTo]
			,[AssignedToEmail]
			,[AssignedToADID]
			--,[AssignedOnUTC]
			,FORMAT(SWITCHOFFSET(AssignedOnUTC, '+05:30'),'yyyy-MM-dd HH:mm:ss') as AssignedOnUTC
			,[AssignedBy]
			,[AssignedByEmail]
			,[AssignedByADID]
			,EA.[CallActionId]
			,CASE 
				WHEN EA.[CallActionId] IS NOT NULL THEN CA.CallAction
				ELSE 'Action Pending'
			 END AS 'CallAction'
			,EA.[CallStatusId]
			,CS.CallStatus
			,[ClosedBy]
			,[ClosedByEmail]
			--,[ClosedOnUTC]
			,FORMAT(SWITCHOFFSET(ClosedOnUTC, '+05:30'),'yyyy-MM-dd HH:mm:ss') as ClosedOnUTC
			,[AdminClosureRemarks]
			,[ClosedByADID]
			--,[CreatedOnUTC]
			,FORMAT(SWITCHOFFSET(CreatedOnUTC, '+05:30'),'yyyy-MM-dd HH:mm:ss') as CreatedOnUTC
		FROM [dbo].[T_EngineerAssignment] EA WITH(NOLOCK)

		INNER JOIN [dbo].[M_CallStatus] CS WITH(NOLOCK) ON CS.CallStatusId = EA.CallStatusId

		LEFT JOIN [dbo].[M_CallAction] CA WITH(NOLOCK) ON CA.CallActionId = EA.CallActionId		

		WHERE (@AssignmentId IS NULL OR EA.AssignmentId = @AssignmentId)
			AND (ISNULL(@CaseNumber,'')='' OR EA.CaseNumber LIKE @CaseNumber + '%')
			AND (@TicketId IS NULL OR EA.TicketId = @TicketId)
			AND (ISNULL(@AssignedTo,'')='' OR EA.AssignedTo LIKE @AssignedTo + '%')
			AND (ISNULL(@AssignedToEmail,'') = '' OR EA.AssignedToEmail = @AssignedToEmail)
			AND (ISNULL(@FromDate,'')= '' OR CONVERT(DATE, SWITCHOFFSET(EA.AssignedOnUTC, '+05:30')) >= CONVERT(DATE, @FromDate,103))
			AND (ISNULL(@ToDate ,'')= '' OR  CONVERT(DATE, SWITCHOFFSET(EA.AssignedOnUTC, '+05:30')) <= CONVERT(DATE, @ToDate,103))
		ORDER BY EA.AssignmentId DESC

		IF(@AssignmentId IS NOT NULL AND @AssignmentId > 0)
		BEGIN

			SELECT
				[AssignmentHistoryId]
				  ,[AssignmentId]
				  ,[CaseNumber]
				  ,[TicketId]
				  ,[AssignedTo]
				  ,[AssignedToEmail]
				  ,[AssignedToADID]
				  --,[AssignedOnUTC]
				  ,FORMAT(SWITCHOFFSET(AssignedOnUTC, '+05:30'),'yyyy-MM-dd HH:mm:ss') as AssignedOnUTC
				  ,[AssignedBy]
				  ,[AssignedByEmail]
				  ,[AssignedByADID]
				  ,CASE 
						WHEN EAH.[CallActionId] IS NOT NULL THEN CA.CallAction
						ELSE 'Action Pending'
					END AS 'CallAction'
				  ,EAH.[CallStatusId]
				  ,CS.CallStatus
				  ,[ClosedBy]
				  ,[ClosedByEmail]
				  ,[ClosedByADID]
				  --,[ClosedOnUTC]
				  ,FORMAT(SWITCHOFFSET(ClosedOnUTC, '+05:30'),'yyyy-MM-dd HH:mm:ss') as ClosedOnUTC
				  ,[AdminClosureRemarks]
				  --,[CreatedOnUTC]
				  ,FORMAT(SWITCHOFFSET(CreatedOnUTC, '+05:30'),'yyyy-MM-dd HH:mm:ss') as CreatedOnUTC
		  FROM [dbo].[T_EngineerAssignmentHistory] EAH WITH(NOLOCK)

		  INNER JOIN [dbo].[M_CallStatus] CS WITH(NOLOCK) ON CS.CallStatusId = EAH.CallStatusId

		  LEFT JOIN [dbo].[M_CallAction] CA WITH(NOLOCK) ON CA.CallActionId = EAH.CallActionId

		  WHERE EAH.AssignmentId = @AssignmentId

		END

  END
GO
PRINT N'Altering Procedure [dbo].[usp_T_EngineerAssignment_InsertUpdate]...';


GO
ALTER PROCEDURE [dbo].[usp_T_EngineerAssignment_InsertUpdate]
(
	@TransactionType VARCHAR(10) = NULL,
	@TicketId BIGINT = NULL,
	@AssignmentId BIGINT = 0,
	@CaseNumber VARCHAR(50) = NULL,
    @AssignedTo VARCHAR(100) = NULL,
    @AssignedToEmail VARCHAR(100) = NULL,
    @AssignedToADID VARCHAR(50) = NULL,
    @AssignedBy VARCHAR(100) = NULL,
    @AssignedByEmail VARCHAR(100) = NULL,
    @AssignedByADID VARCHAR(50) = NULL,
    @CallActionId INT = NULL,
    @CallStatusId INT = NULL,
    @ClosedBy VARCHAR(100) = NULL,
    @ClosedByEmail VARCHAR(100) = NULL,
    @ClosedByADID VARCHAR(100) = NULL,
    @AdminClosureRemarks NVARCHAR(MAX) = NULL
)
AS
BEGIN
	
	DECLARE @AssignmentHistoryId BIGINT = 0;
	DECLARE @SuccessMsg VARCHAR(100);
	DECLARE @ErrorMsg VARCHAR(100);


	IF(@TransactionType = 'ENG-I')
	BEGIN
	BEGIN TRY
	-----------------

	IF EXISTS (SELECT * FROM dbo.[T_EngineerAssignment] A WITH(NOLOCK) WHERE A.CaseNumber = @CaseNumber AND A.CallStatusId <> 3)
	BEGIN
		SET @ErrorMsg = 'DB execution failed - CaseNumber already assigned'
		SELECT
			@ErrorMsg												AS [Message],
			''														AS ErrorMessage,
			0					                                    AS [Status],
			@AssignmentId				                            AS Id
			RETURN
	END

	BEGIN TRANSACTION
	-----------------

		INSERT INTO dbo.[T_EngineerAssignment]
		(
			CaseNumber,
			TicketId,
			AssignedTo,
			AssignedToEmail,
			AssignedToADID,
			AssignedOnUTC,
			AssignedBy,
			AssignedByEmail,
			AssignedByADID,
			CallStatusId,
			CreatedOnUTC
		)
		VALUES
		(
			@CaseNumber,
			@TicketId,
			@AssignedTo,
			@AssignedToEmail,
			@AssignedToADID,
			GETUTCDATE(),
			@AssignedBy,
			@AssignedByEmail,
			@AssignedByADID,
			1,
			GETUTCDATE()
		);

		SET @AssignmentId = @@IDENTITY;

		IF(@AssignmentId > 0)
		BEGIN

			INSERT INTO dbo.[T_EngineerAssignmentHistory]
			(
				AssignmentId,
				TicketId,
				AssignedTo,
				AssignedToEmail,
				AssignedToADID,
				AssignedOnUTC,
				AssignedBy,
				AssignedByEmail,
				AssignedByADID,
				CallActionId,
				CallStatusId,
				ClosedBy,
				ClosedByEmail,
				ClosedByADID,
				AdminClosureRemarks,
				CreatedOnUTC,
				CaseNumber
			)
			SELECT
				A.AssignmentId,
				A.TicketId,
				A.AssignedTo,
				A.AssignedToEmail,
				A.AssignedToADID,
				A.AssignedOnUTC,
				A.AssignedBy,
				A.AssignedByEmail,
				A.AssignedByADID,
				A.CallActionId,
				A.CallStatusId,
				A.ClosedBy,
				A.ClosedByEmail,
				A.ClosedByADID,
				A.AdminClosureRemarks,
				GETUTCDATE(),
				A.CaseNumber
			FROM dbo.[T_EngineerAssignment] A WITH(NOLOCK)
			WHERE A.AssignmentId = @AssignmentId

			SET @AssignmentHistoryId = @@IDENTITY;


			UPDATE dbo.[T_TicketDetails] SET TicketId = @TicketId WHERE CaseNumber = @CaseNumber;


			SET @SuccessMsg = 'DB execution successful - EngineerAssignment inserted';

		END		

	END TRY
	-----------------
	BEGIN CATCH
	-----------------
	ROLLBACK TRANSACTION
	SET @ErrorMsg = 'DB execution failed - Insert EngineerAssignment'
    SELECT
        @ErrorMsg												AS [Message],
        ERROR_MESSAGE()		                                    AS ErrorMessage,
        0					                                    AS [Status],
        ''				                                        AS Id
        RETURN
	END CATCH
	-----------------
	END

	--------------------------------------------------------------------------------

	IF(@TransactionType = 'ENG-U')
	BEGIN
	BEGIN TRY
	-----------------

		IF NOT EXISTS (SELECT * FROM dbo.[T_EngineerAssignment] A WITH(NOLOCK) WHERE A.AssignmentId = @AssignmentId)
		BEGIN
			SET @ErrorMsg = 'DB execution failed - AssignmentId does not exists'
			SELECT
				@ErrorMsg												AS [Message],
				''														AS ErrorMessage,
				0					                                    AS [Status],
				@AssignmentId				                            AS Id
				RETURN
		END

	BEGIN TRANSACTION
	-----------------

		UPDATE dbo.[T_EngineerAssignment]
		SET AssignedTo = ISNULL(@AssignedTo, AssignedTo),
		AssignedToEmail = ISNULL(@AssignedToEmail, AssignedToEmail),
		AssignedToADID = ISNULL(@AssignedToADID, AssignedToADID),
		AssignedOnUTC = GETUTCDATE(),
		AssignedBy = ISNULL(@AssignedBy, AssignedBy),
		AssignedByEmail = ISNULL(@AssignedByEmail, AssignedByEmail),
		AssignedByADID = ISNULL(@AssignedByADID, AssignedByADID)
		WHERE AssignmentId = @AssignmentId AND CaseNumber = @CaseNumber AND CallStatusId <> 3


		INSERT INTO dbo.[T_EngineerAssignmentHistory]
		(
			AssignmentId,
			TicketId,
			AssignedTo,
			AssignedToEmail,
			AssignedToADID,
			AssignedOnUTC,
			AssignedBy,
			AssignedByEmail,
			AssignedByADID,
			CallActionId,
			CallStatusId,
			ClosedBy,
			ClosedByEmail,
			ClosedByADID,
			AdminClosureRemarks,
			CreatedOnUTC,
			CaseNumber
		)
		SELECT
			A.AssignmentId,
			A.TicketId,
			A.AssignedTo,
			A.AssignedToEmail,
			A.AssignedToADID,
			A.AssignedOnUTC,
			A.AssignedBy,
			A.AssignedByEmail,
			A.AssignedByADID,
			A.CallActionId,
			A.CallStatusId,
			A.ClosedBy,
			A.ClosedByEmail,
			A.ClosedByADID,
			A.AdminClosureRemarks,
			GETUTCDATE(),
			A.CaseNumber
		FROM dbo.[T_EngineerAssignment] A WITH(NOLOCK)
		WHERE A.AssignmentId = @AssignmentId

		
		SET @SuccessMsg = 'DB execution successful - EngineerAssignment updated';

	END TRY
	-----------------
	BEGIN CATCH
	-----------------
	ROLLBACK TRANSACTION
	SET @ErrorMsg = 'DB execution failed - Update EngineerAssignment'
    SELECT
        @ErrorMsg												AS [Message],
        ERROR_MESSAGE()		                                    AS ErrorMessage,
        0					                                    AS [Status],
        ''				                                        AS Id
        RETURN
	END CATCH
	-----------------
	END
	
	--------------------------------------------------------------------------------

	IF(@TransactionType = 'ADMIN-U')
	BEGIN
	BEGIN TRY
	-----------------

		IF NOT EXISTS (SELECT * FROM dbo.[T_EngineerAssignment] A WITH(NOLOCK) WHERE A.AssignmentId = @AssignmentId)
		BEGIN
			SET @ErrorMsg = 'DB execution failed - AssignmentId does not exists'
			SELECT
				@ErrorMsg												AS [Message],
				''														AS ErrorMessage,
				0					                                    AS [Status],
				@AssignmentId				                            AS Id
				RETURN
		END

	BEGIN TRANSACTION
	-----------------

		UPDATE dbo.[T_EngineerAssignment]
		SET CallStatusId = ISNULL(@CallStatusId, CallStatusId),
		AdminClosureRemarks = ISNULL(@AdminClosureRemarks, AdminClosureRemarks)
		WHERE AssignmentId = @AssignmentId AND CaseNumber = @CaseNumber;

		--IF(@CallActionId = 1 AND @CallStatusId = 3)
		IF(@CallStatusId = 3)
		BEGIN

			UPDATE dbo.[T_EngineerAssignment]
			SET ClosedBy = ISNULL(@ClosedBy, ClosedBy),
			ClosedByEmail = ISNULL(@ClosedByEmail, ClosedByEmail),
			ClosedByADID = ISNULL(@ClosedByADID, ClosedByADID),
			ClosedOnUTC = GETUTCDATE()
			WHERE AssignmentId = @AssignmentId AND CaseNumber = @CaseNumber;

		END
		
		SET @SuccessMsg = 'DB execution successful - EngineerAssignment updated by Admin';

	END TRY
	-----------------
	BEGIN CATCH
	-----------------
	ROLLBACK TRANSACTION
	SET @ErrorMsg = 'DB execution failed - Admin Update EngineerAssignment'
    SELECT
        @ErrorMsg												AS [Message],
        ERROR_MESSAGE()		                                    AS ErrorMessage,
        0					                                    AS [Status],
        ''				                                        AS Id
        RETURN
	END CATCH
	-----------------
	END


	COMMIT TRANSACTION
	-----------------
	SELECT
		@SuccessMsg												AS [Message],
		''						                                AS ErrorMessage,
		1					                                    AS [Status],
		@AssignmentId											AS Id,
		@CaseNumber												AS ReferenceNo
END
GO
PRINT N'Altering Procedure [dbo].[usp_T_EngineerAssignmentHistory_Get]...';


GO
ALTER PROCEDURE usp_T_EngineerAssignmentHistory_Get
  (
	@AssignmentId BIGINT = NULL,
    @FromDate VARCHAR(10) = NULL,
    @ToDate VARCHAR(10) = NULL
  )
  AS
  BEGIN

		SELECT 
			[AssignmentHistoryId]
			,[AssignmentId]
			,[CaseNumber]
			,[TicketId]
			,[AssignedTo]
			,[AssignedToEmail]
			,[AssignedToADID]
			,[AssignedOnUTC]
			,[AssignedBy]
			,[AssignedByEmail]
			,[AssignedByADID]
			,[CallActionId]
			,[CallStatusId]
			,[ClosedBy]
			,[ClosedByEmail]
			,[ClosedByADID]
			,[ClosedOnUTC]
			,[AdminClosureRemarks]
			,[CreatedOnUTC]
		FROM [dbo].[T_EngineerAssignmentHistory] EA WITH(NOLOCK)
		WHERE @AssignmentId IS NULL OR EA.AssignmentId = @AssignmentId
			AND (ISNULL(@FromDate,'')= '' OR CONVERT(DATE, SWITCHOFFSET(EA.AssignedOnUTC, '+05:30')) >= CONVERT(DATE, @FromDate,103))
			AND (ISNULL(@ToDate ,'')= '' OR  CONVERT(DATE, SWITCHOFFSET(EA.AssignedOnUTC, '+05:30')) <= CONVERT(DATE, @ToDate,103))
		ORDER BY EA.AssignmentHistoryId DESC

  END
GO
PRINT N'Creating Procedure [dbo].[usp_TicketInBulk_Insert]...';


GO
CREATE PROCEDURE [dbo].[usp_TicketInBulk_Insert]
(
	@udt_TicketDetailsList dbo.[udt_T_TicketDetails] READONLY
)
AS
BEGIN

	DECLARE @SuccessMsg VARCHAR(100);
	DECLARE @ErrorMsg VARCHAR(100);

	DECLARE @DuplicateTicketIds VARCHAR(MAX) = NULL;

	DECLARE @DuplicateTicketTbl AS TABLE
	(
		CaseNumber VARCHAR(50) NULL
	)

	INSERT INTO @DuplicateTicketTbl SELECT udt.CaseNumber FROM @udt_TicketDetailsList udt WHERE udt.CaseNumber IN (SELECT TD.CaseNumber FROM dbo.[T_TicketDetails] TD WITH(NOLOCK));

	IF EXISTS (SELECT * FROM @DuplicateTicketTbl)
	BEGIN
		
		;WITH CTE AS
        (
			SELECT CaseNumber
			FROM @DuplicateTicketTbl
        )
        SELECT @DuplicateTicketIds = CONCAT(@DuplicateTicketIds,',',CaseNumber) FROM CTE

		SET @DuplicateTicketIds = 'Following ticket id(s) already exist in the database: ' + @DuplicateTicketIds;

	END

	BEGIN TRY
	-----------------

		BEGIN TRANSACTION
		-----------------

		-- INSERT TICKETS
		INSERT INTO [dbo].[T_TicketDetails] 
		(
			[CaseNumber],
			[TicketId],
			--[FromEmail],
			--[ToEmail],
			[CaseSubject],
			--[WorkOrderNumber],
			--[ServiceAccount],
			[ContactName],
			[ContactEmail],
			--[ContactPhone],
			--[ServiceDeliveryStreetAddress],
			--[ServiceDeliveryCity],
			--[ServiceDeliveryCountry],
			--[PostalCode],
			[SerialNumber],
			[ProductName],
			[ProductNumber],
			--[OTCCode],
			--[PartNumber],
			--[PartDescription],
			--[EmailSubject],
			--[EmailDate],
			[CreatedOn],
			--[PartNumber2],
			--[PartDescription2],
			--[PartNumber3],
			--[PartDescription3]
			[TicketType]
		)
		SELECT
			udt.CaseNumber,
			udt.TicketId,
			udt.CaseSubject,
			udt.ContactName,
			udt.ContactEmail,
			udt.SerialNumber,
			udt.ProductName,
			udt.ProductNumber,
			CONVERT(DATETIME, udt.CreatedOn),
			udt.TicketType
		FROM @udt_TicketDetailsList udt WHERE udt.CaseNumber NOT IN (SELECT CaseNumber FROM @DuplicateTicketTbl)

		SET @SuccessMsg = 'DB execution successful - Ticket(s) inserted from CSV';

		-- ASSIGN ENGINEERS
		INSERT INTO dbo.[T_EngineerAssignment]
		(
			CaseNumber,
			TicketId,
			AssignedTo,
			AssignedToEmail,
			AssignedToADID,
			AssignedOnUTC,
			AssignedBy,
			AssignedByEmail,
			AssignedByADID,
			CallStatusId,
			CreatedOnUTC
		)
		SELECT
			udt.CaseNumber,
			udt.TicketId,
			udt.AssignedTo,
			udt.AssignedToEmail,
			udt.AssignedToADID,
			GETUTCDATE(),
			udt.AssignedBy,
			udt.AssignedByEmail,
			udt.AssignedByADID,
			1,
			GETUTCDATE()
		FROM @udt_TicketDetailsList udt
		INNER JOIN dbo.[T_TicketDetails] TD ON TD.CaseNumber = udt.CaseNumber

		SET @SuccessMsg = @SuccessMsg + ' & Assigned to engineer(s)';

	END TRY
	-----------------
	BEGIN CATCH
	-----------------
		
		ROLLBACK TRANSACTION
		SET @ErrorMsg = 'DB execution failed - Insert ticket(s) from CSV'
		SELECT
		@ErrorMsg												AS [Message],
		ERROR_MESSAGE()		                                    AS ErrorMessage,
		0					                                    AS [Status],
		''				                                        AS Id
		RETURN

	END CATCH
	-----------------

	COMMIT TRANSACTION
	-----------------
	SELECT
		@SuccessMsg												AS [Message],
		''						                                AS ErrorMessage,
		1					                                    AS [Status],
		@@IDENTITY												AS Id,
		@DuplicateTicketIds										AS ReferenceNo

END
GO
PRINT N'Refreshing Procedure [dbo].[usp_T_TicketTimeline_ByCaseNumber]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_T_TicketTimeline_ByCaseNumber]';


GO
PRINT N'Refreshing Procedure [dbo].[usp_Ticket_Get]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_Ticket_Get]';


GO
PRINT N'Refreshing Procedure [dbo].[usp_Ticket_Insert]...';


GO
EXECUTE sp_refreshsqlmodule N'[dbo].[usp_Ticket_Insert]';


GO
PRINT N'Update complete.';


GO
