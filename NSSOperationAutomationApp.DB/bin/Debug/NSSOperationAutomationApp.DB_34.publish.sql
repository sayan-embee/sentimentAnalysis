/*
Deployment script for NSSOperationAutomationP1

This code was generated by a tool.
Changes to this file may cause incorrect behavior and will be lost if
the code is regenerated.
*/

GO
SET ANSI_NULLS, ANSI_PADDING, ANSI_WARNINGS, ARITHABORT, CONCAT_NULL_YIELDS_NULL, QUOTED_IDENTIFIER ON;

SET NUMERIC_ROUNDABORT OFF;


GO
:setvar DatabaseName "NSSOperationAutomationP1"
:setvar DefaultFilePrefix "NSSOperationAutomationP1"
:setvar DefaultDataPath "D:\Microsoft SQL Server\MSSQL16.MSSQLSERVER01\MSSQL\DATA\"
:setvar DefaultLogPath "D:\Microsoft SQL Server\MSSQL16.MSSQLSERVER01\MSSQL\DATA\"

GO
:on error exit
GO
/*
Detect SQLCMD mode and disable script execution if SQLCMD mode is not supported.
To re-enable the script after enabling SQLCMD mode, execute the following:
SET NOEXEC OFF; 
*/
:setvar __IsSqlCmdEnabled "True"
GO
IF N'$(__IsSqlCmdEnabled)' NOT LIKE N'True'
    BEGIN
        PRINT N'SQLCMD mode must be enabled to successfully execute this script.';
        SET NOEXEC ON;
    END


GO
USE [$(DatabaseName)];


GO
PRINT N'Altering Procedure [dbo].[usp_M_Conversation_Get]...';


GO

ALTER PROCEDURE [dbo].[usp_M_Conversation_Get]
(
	@ConversationId NVARCHAR(200)=NULL,
	@UserId UNIQUEIDENTIFIER =NULL,
	@AppName NVARCHAR(50)=NULL,
	@UserName NVARCHAR(50)=NULL,
	@UserEmail NVARCHAR(200)=NULL,
	@Filter NVARCHAR(500)=NULL
)
AS
BEGIN
	SELECT 
		V.ActivityId,
		V.BotInstalledOn,
		V.BotRemovedOn,
		V.ConversationId,
		V.RecipientId,
		V.RecipientName,
		V.ServiceUrl,
		V.UserEmail,
		V.TenantId,
		V.UserId,
		V.UserName,
		V.UserEmail,
		V.UserPrincipalName,
		V.AppName,
		V.Active

	FROM dbo.[T_Conversations] V WITH (NOLOCK)
	WHERE V.ConversationId=CASE WHEN ISNULL(@ConversationId,'')='' THEN  V.ConversationId ELSE @ConversationId END
	AND V.UserId=CASE WHEN @UserId IS NULL  THEN  V.UserId ELSE @UserId END
	AND V.AppName=CASE WHEN @AppName IS NULL  THEN  V.AppName ELSE @AppName END
	AND (ISNULL(@UserName,'')='' OR V.UserName LIKE @UserName + '%')
	AND (ISNULL(@UserEmail,'')='' OR V.UserEmail = @UserEmail)
	AND (ISNULL(@Filter,'')='' OR (V.UserEmail = @Filter OR V.UserName LIKE @Filter + '%'))
END
GO
PRINT N'Update complete.';


GO
